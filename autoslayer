local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local AutoFarmActive = false
local currentTarget = nil
local connection = nil
local isExecuting = false
local deadQueue = {}

local alignPos, alignOri, attachment = nil, nil, nil

-- CONFIGURAÇÕES
local HEIGHT = 6
local BACK = 2
local ANGLE = -70
local TP_DIST = 50
local ATTACK_DIST = 10
local SAFE_RADIUS = 20
local EXECUTE_WAIT = 2.5

-- ================== GUI ==================
local gui = Instance.new("ScreenGui")
gui.Name = "AutoFarmPro"
gui.ResetOnSpawn = false
gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 160, 0, 100)
frame.Position = UDim2.new(0, 10, 0.5, -50)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
frame.BorderSizePixel = 0
frame.Parent = gui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 25)
title.BackgroundTransparency = 1
title.Text = "AutoFarm Pro v7"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 14
title.Font = Enum.Font.GothamBold
title.Parent = frame

local status = Instance.new("TextLabel")
status.Size = UDim2.new(1, 0, 0, 15)
status.Position = UDim2.new(0, 0, 0, 23)
status.BackgroundTransparency = 1
status.Text = "Desligado"
status.TextColor3 = Color3.fromRGB(150, 150, 150)
status.TextSize = 11
status.Font = Enum.Font.Gotham
status.Parent = frame

local btn = Instance.new("TextButton")
btn.Size = UDim2.new(0.85, 0, 0, 35)
btn.Position = UDim2.new(0.075, 0, 0, 55)
btn.BackgroundColor3 = Color3.fromRGB(180, 40, 40)
btn.Text = "DESLIGADO"
btn.TextColor3 = Color3.fromRGB(255, 255, 255)
btn.TextSize = 14
btn.Font = Enum.Font.GothamBold
btn.Parent = frame
Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)

-- ================== HELPERS ==================
local function getHRP()
    local char = LocalPlayer.Character
    return char and char:FindFirstChild("HumanoidRootPart")
end

local function getRoot(m)
    return m:FindFirstChild("HumanoidRootPart") or m:FindFirstChild("Torso") or m:FindFirstChild("UpperTorso")
end

local function getHealthValue(m)
    local h = m:FindFirstChild("Health")
    if h then return h.Value end
    return -1
end

local function dist(a, b)
    return (a - b).Magnitude
end

-- ================== REMOTES (igual original) ==================
local remotes = ReplicatedStorage:WaitForChild("Remotes")

local function doAttack(npc)
    local async = remotes:WaitForChild("Async")
    if npc:FindFirstChild("Block") then
        async:FireServer("Katana", "Heavy")
    else
        async:FireServer("Katana", "Server")
    end
end

local function doExecute()
    local sync = remotes:WaitForChild("Sync")
    sync:InvokeServer("Character", "Execute")
end

-- ================== MOVIMENTO ==================
local function setupMovement()
    local hrp = getHRP()
    if not hrp then return end
    
    if attachment then attachment:Destroy() end
    if alignPos then alignPos:Destroy() end
    if alignOri then alignOri:Destroy() end
    
    attachment = Instance.new("Attachment")
    attachment.Parent = hrp
    
    alignPos = Instance.new("AlignPosition")
    alignPos.Mode = Enum.PositionAlignmentMode.OneAttachment
    alignPos.Attachment0 = attachment
    alignPos.MaxForce = 100000
    alignPos.MaxVelocity = 80
    alignPos.Responsiveness = 30
    alignPos.Parent = hrp
    
    alignOri = Instance.new("AlignOrientation")
    alignOri.Mode = Enum.OrientationAlignmentMode.OneAttachment
    alignOri.Attachment0 = attachment
    alignOri.MaxTorque = 100000
    alignOri.Responsiveness = 30
    alignOri.Parent = hrp
end

local function clearMovement()
    if attachment then attachment:Destroy() attachment = nil end
    if alignPos then alignPos:Destroy() alignPos = nil end
    if alignOri then alignOri:Destroy() alignOri = nil end
end

local function getFarmCF(npcRoot)
    local pos = npcRoot.Position
    local look = npcRoot.CFrame.LookVector
    local targetPos = pos + Vector3.new(0, HEIGHT, 0) - (look * BACK)
    local cf = CFrame.new(targetPos, pos)
    return cf * CFrame.Angles(math.rad(ANGLE), 0, 0)
end

-- ================== BUSCA ==================
local function findClosestAlive()
    local hrp = getHRP()
    if not hrp then return nil, nil, math.huge end
    
    local closest, closestRoot, closestDist = nil, nil, math.huge
    
    for _, npc in ipairs(workspace:GetChildren()) do
        if npc.Name == "GenericSlayer" and npc:IsA("Model") then
            local root = getRoot(npc)
            local hp = getHealthValue(npc)
            
            if root and hp > 0 then
                local d = dist(hrp.Position, root.Position)
                if d < closestDist then
                    closest = npc
                    closestRoot = root
                    closestDist = d
                end
            end
        end
    end
    
    return closest, closestRoot, closestDist
end

local function hasAliveNear(position)
    for _, npc in ipairs(workspace:GetChildren()) do
        if npc.Name == "GenericSlayer" and npc:IsA("Model") then
            local root = getRoot(npc)
            local hp = getHealthValue(npc)
            if root and hp > 0 then
                if dist(root.Position, position) <= SAFE_RADIUS then
                    return true
                end
            end
        end
    end
    return false
end

local function findExecutableDead()
    local hrp = getHRP()
    if not hrp then return nil, nil end
    
    for _, npc in ipairs(workspace:GetChildren()) do
        if npc.Name == "GenericSlayer" and npc:IsA("Model") then
            local root = getRoot(npc)
            local hp = getHealthValue(npc)
            
            if root and hp ~= -1 and hp <= 0 then
                local pos = root.Position
                if not hasAliveNear(pos) then
                    return npc, pos
                end
            end
        end
    end
    
    return nil, nil
end

-- ================== EXECUÇÃO ==================
local function tryExecute(npc, pos)
    if isExecuting then return end
    isExecuting = true
    
    status.Text = "Executando..."
    print(">>> Executando slayer")
    
    local hrp = getHRP()
    if not hrp then
        isExecuting = false
        return
    end
    
    -- Desliga movimento suave
    if alignPos then alignPos.Enabled = false end
    if alignOri then alignOri.Enabled = false end
    
    -- TP pra perto (2 studs acima)
    hrp.CFrame = CFrame.new(pos + Vector3.new(0, 2, 0), pos)
    task.wait(0.3)
    
    -- Checa se ainda seguro
    if hasAliveNear(pos) then
        print(">>> Cancelado - vivo perto!")
        if alignPos then alignPos.Enabled = true end
        if alignOri then alignOri.Enabled = true end
        isExecuting = false
        return
    end
    
    -- Executa
    doExecute()
    print(">>> Execute chamado!")
    
    task.wait(EXECUTE_WAIT)
    
    if alignPos then alignPos.Enabled = true end
    if alignOri then alignOri.Enabled = true end
    isExecuting = false
end

-- ================== LOOP PRINCIPAL ==================
local function mainLoop()
    if not AutoFarmActive then return end
    if isExecuting then return end
    
    local hrp = getHRP()
    if not hrp then return end
    
    if not alignPos or not alignPos.Parent then
        setupMovement()
    end
    
    -- 1. PROCURA VIVO
    local npc, root, d = findClosestAlive()
    
    if npc and root then
        local hp = getHealthValue(npc)
        
        -- VIVO - ATACA
        if hp > 0 then
            currentTarget = npc
            
            -- TP se longe
            if d > TP_DIST then
                status.Text = "TP..."
                hrp.CFrame = getFarmCF(root)
                return
            end
            
            -- Move suave
            local cf = getFarmCF(root)
            alignPos.Position = cf.Position
            alignOri.CFrame = cf
            
            -- Ataca se perto
            if d <= ATTACK_DIST then
                status.Text = "Atacando"
                doAttack(npc)
            else
                status.Text = "Indo..."
            end
            return
        end
    end
    
    -- 2. SEM VIVO - TENTA EXECUTAR
    currentTarget = nil
    
    -- Primeiro da fila
    if #deadQueue > 0 then
        local data = deadQueue[1]
        if data.npc and data.npc.Parent then
            local hp = getHealthValue(data.npc)
            if hp <= 0 and not hasAliveNear(data.pos) then
                table.remove(deadQueue, 1)
                tryExecute(data.npc, data.pos)
                return
            end
        else
            table.remove(deadQueue, 1)
        end
    end
    
    -- Procura qualquer morto executável
    local deadNpc, deadPos = findExecutableDead()
    if deadNpc then
        tryExecute(deadNpc, deadPos)
        return
    end
    
    status.Text = "Procurando..."
end

-- Loop separado pra detectar morte do alvo
local function deathCheck()
    if not AutoFarmActive then return end
    if not currentTarget then return end
    
    local hp = getHealthValue(currentTarget)
    if hp ~= -1 and hp <= 0 then
        local root = getRoot(currentTarget)
        if root then
            -- Verifica se já tá na fila
            local found = false
            for _, d in ipairs(deadQueue) do
                if d.npc == currentTarget then found = true break end
            end
            
            if not found then
                print(">>> Alvo morreu! Adicionando na fila")
                table.insert(deadQueue, {npc = currentTarget, pos = root.Position})
            end
        end
        currentTarget = nil
    end
end

-- ================== CONTROLE ==================
local function start()
    setupMovement()
    deadQueue = {}
    currentTarget = nil
    
    -- Executa mortos ao ligar
    local deadNpc, deadPos = findExecutableDead()
    if deadNpc then
        tryExecute(deadNpc, deadPos)
    end
    
    connection = RunService.Heartbeat:Connect(function()
        deathCheck()
        mainLoop()
    end)
end

local function stop()
    if connection then
        connection:Disconnect()
        connection = nil
    end
    clearMovement()
    currentTarget = nil
    deadQueue = {}
    isExecuting = false
    status.Text = "Desligado"
end

-- ================== TOGGLE ==================
btn.MouseButton1Click:Connect(function()
    AutoFarmActive = not AutoFarmActive
    
    if AutoFarmActive then
        btn.BackgroundColor3 = Color3.fromRGB(40, 180, 40)
        btn.Text = "LIGADO"
        start()
    else
        btn.BackgroundColor3 = Color3.fromRGB(180, 40, 40)
        btn.Text = "DESLIGADO"
        stop()
    end
end)

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    if AutoFarmActive then setupMovement() end
end)

print("AutoFarm Pro v7 carregado!")
