local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local AutoFarmActive = false
local followingSlayer = nil
local connection = nil
local deadSlayers = {} -- {npc, position}

local alignPos = nil
local alignOri = nil
local attachment = nil

-- CONFIGURAÇÕES
local HEIGHT_OFFSET = 7
local FORWARD_OFFSET = 0.5
local LOOK_DOWN_ANGLE = -80
local MOVE_SPEED = 80
local RESPONSIVENESS = 30
local TP_DISTANCE = 30
local ATTACK_DISTANCE = 10
local SAFE_RADIUS = 20 -- Raio pra verificar slayers vivos perto do MORTO

-- ================== GUI ==================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoFarmGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 150, 0, 100)
Frame.Position = UDim2.new(0, 10, 0.5, -50)
Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = Frame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 25)
Title.BackgroundTransparency = 1
Title.Text = "AutoFarm v5"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 14
Title.Font = Enum.Font.GothamBold
Title.Parent = Frame

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, 0, 0, 15)
StatusLabel.Position = UDim2.new(0, 0, 0, 22)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Parado"
StatusLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
StatusLabel.TextSize = 11
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.Parent = Frame

local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Size = UDim2.new(0.8, 0, 0, 35)
ToggleBtn.Position = UDim2.new(0.1, 0, 0, 55)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
ToggleBtn.Text = "OFF"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 16
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.Parent = Frame

local BtnCorner = Instance.new("UICorner")
BtnCorner.CornerRadius = UDim.new(0, 6)
BtnCorner.Parent = ToggleBtn

-- ================== FUNÇÕES HELPER ==================
local function getRoot(model)
    return model:FindFirstChild("HumanoidRootPart") 
        or model:FindFirstChild("Torso") 
        or model:FindFirstChild("UpperTorso")
end

local function getHealth(model)
    return model:FindFirstChild("Health")
end

local function setStatus(txt)
    StatusLabel.Text = txt
end

local function getDistance(pos1, pos2)
    return (pos1 - pos2).Magnitude
end

-- Verifica se tem slayers VIVOS perto de uma posição
local function hasAliveSlayersNear(position, radius)
    for _, npc in ipairs(workspace:GetChildren()) do
        if npc.Name == "GenericSlayer" and npc:IsA("Model") then
            local root = getRoot(npc)
            local health = getHealth(npc)
            if root and health and health.Value > 0 then
                if getDistance(root.Position, position) <= radius then
                    return true
                end
            end
        end
    end
    return false
end

-- Pega slayer vivo mais próximo
local function pickClosestAliveSlayer()
    local char = LocalPlayer.Character
    if not char then return nil end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    
    local closest = nil
    local closestDist = math.huge
    
    for _, npc in ipairs(workspace:GetChildren()) do
        if npc.Name == "GenericSlayer" and npc:IsA("Model") then
            local root = getRoot(npc)
            local health = getHealth(npc)
            if root and health and health.Value > 0 then
                local dist = getDistance(root.Position, hrp.Position)
                if dist < closestDist then
                    closestDist = dist
                    closest = npc
                end
            end
        end
    end
    return closest, closestDist
end

-- Pega slayer MORTO mais próximo que pode ser executado (sem vivos perto dele)
local function pickExecutableDeadSlayer()
    local char = LocalPlayer.Character
    if not char then return nil end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    
    local closest = nil
    local closestDist = math.huge
    local closestPos = nil
    
    for _, npc in ipairs(workspace:GetChildren()) do
        if npc.Name == "GenericSlayer" and npc:IsA("Model") then
            local root = getRoot(npc)
            local health = getHealth(npc)
            if root and health and health.Value <= 0 then
                local pos = root.Position
                -- Verifica se não tem vivo perto desse morto
                if not hasAliveSlayersNear(pos, SAFE_RADIUS) then
                    local dist = getDistance(pos, hrp.Position)
                    if dist < closestDist then
                        closestDist = dist
                        closest = npc
                        closestPos = pos
                    end
                end
            end
        end
    end
    return closest, closestPos
end

-- Pega próximo da fila de mortos
local function getNextDeadFromQueue()
    for i, data in ipairs(deadSlayers) do
        local npc = data.npc
        if npc and npc.Parent then
            local health = getHealth(npc)
            if health and health.Value <= 0 then
                -- Verifica se não tem vivo perto
                if not hasAliveSlayersNear(data.position, SAFE_RADIUS) then
                    return data, i
                end
            else
                table.remove(deadSlayers, i)
                return getNextDeadFromQueue()
            end
        else
            table.remove(deadSlayers, i)
            return getNextDeadFromQueue()
        end
    end
    return nil, nil
end

-- ================== REMOTES ==================
local function executeSlayer()
    local remote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Sync")
    remote:InvokeServer("Character", "Execute")
end

local function attackSlayer(npc)
    local attackRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Async")
    if npc:FindFirstChild("Block") then
        attackRemote:FireServer("Katana", "Heavy")
    else
        attackRemote:FireServer("Katana", "Server")
    end
end

-- ================== MOVIMENTO ==================
local function setupSmoothMovement(hrp)
    if attachment then attachment:Destroy() end
    if alignPos then alignPos:Destroy() end
    if alignOri then alignOri:Destroy() end
    
    attachment = Instance.new("Attachment")
    attachment.Name = "AutoFarmAttachment"
    attachment.Parent = hrp
    
    alignPos = Instance.new("AlignPosition")
    alignPos.Mode = Enum.PositionAlignmentMode.OneAttachment
    alignPos.Attachment0 = attachment
    alignPos.MaxForce = 100000
    alignPos.MaxVelocity = MOVE_SPEED
    alignPos.Responsiveness = RESPONSIVENESS
    alignPos.Parent = hrp
    
    alignOri = Instance.new("AlignOrientation")
    alignOri.Mode = Enum.OrientationAlignmentMode.OneAttachment
    alignOri.Attachment0 = attachment
    alignOri.MaxTorque = 100000
    alignOri.Responsiveness = RESPONSIVENESS
    alignOri.Parent = hrp
end

local function removeSmoothMovement()
    if attachment then attachment:Destroy() attachment = nil end
    if alignPos then alignPos:Destroy() alignPos = nil end
    if alignOri then alignOri:Destroy() alignOri = nil end
end

-- Posição de farm: ACIMA do NPC, levemente na frente, olhando pra baixo
local function getFarmCFrame(npcRoot)
    local npcPos = npcRoot.Position
    local npcLook = npcRoot.CFrame.LookVector
    
    local targetPos = npcPos + Vector3.new(0, HEIGHT_OFFSET, 0) + (npcLook * FORWARD_OFFSET)
    local baseCFrame = CFrame.new(targetPos, targetPos + npcLook)
    local finalCFrame = baseCFrame * CFrame.Angles(math.rad(LOOK_DOWN_ANGLE), 0, 0)
    
    return finalCFrame
end

-- ================== EXECUÇÃO ==================
local function doExecute(npc, position)
    local char = LocalPlayer.Character
    if not char then return false end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    
    setStatus("Executando...")
    
    -- Desativa movimento suave temporariamente
    if alignPos then alignPos.Enabled = false end
    if alignOri then alignOri.Enabled = false end
    
    -- TP pro chão perto do slayer (3 studs de altura)
    local executePos = position + Vector3.new(0, 3, 0)
    hrp.CFrame = CFrame.new(executePos, position)
    task.wait(0.3)
    
    -- Executa
    executeSlayer()
    print("Executado:", npc.Name)
    
    task.wait(2.5) -- Animação de execução
    
    -- Reativa movimento suave
    if alignPos then alignPos.Enabled = true end
    if alignOri then alignOri.Enabled = true end
    
    return true
end

-- ================== LOOP PRINCIPAL ==================
local function startAutofarm()
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    setupSmoothMovement(hrp)
    deadSlayers = {}
    
    -- AO LIGAR: Verifica se tem morto executável por perto
    local deadNpc, deadPos = pickExecutableDeadSlayer()
    if deadNpc then
        doExecute(deadNpc, deadPos)
    end
    
    connection = RunService.Heartbeat:Connect(function()
        if not AutoFarmActive then return end
        
        local char = LocalPlayer.Character
        if not char then return end
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        
        if not alignPos or not alignPos.Parent then
            setupSmoothMovement(hrp)
        end

        local myPos = hrp.Position

        -- FASE 1: Procura slayer VIVO
        local aliveSlayer, aliveDist = pickClosestAliveSlayer()
        
        if aliveSlayer then
            followingSlayer = aliveSlayer
            local root = getRoot(followingSlayer)
            local health = getHealth(followingSlayer)
            
            if root and health then
                local dist = getDistance(myPos, root.Position)
                
                -- TP se muito longe
                if dist > TP_DISTANCE then
                    setStatus("Teleportando...")
                    hrp.CFrame = getFarmCFrame(root)
                    task.wait(0.1)
                    return
                end
                
                -- Movimento suave
                local targetCF = getFarmCFrame(root)
                alignPos.Position = targetCF.Position
                alignOri.CFrame = targetCF
                
                if health.Value > 0 then
                    if dist <= ATTACK_DISTANCE then
                        setStatus("Atacando: " .. followingSlayer.Name)
                        attackSlayer(followingSlayer)
                    else
                        setStatus("Indo até: " .. followingSlayer.Name)
                    end
                else
                    -- Morreu! Adiciona na fila
                    local alreadyInList = false
                    for _, data in ipairs(deadSlayers) do
                        if data.npc == followingSlayer then
                            alreadyInList = true
                            break
                        end
                    end
                    
                    if not alreadyInList then
                        table.insert(deadSlayers, {
                            npc = followingSlayer,
                            position = root.Position
                        })
                        print("Na fila:", followingSlayer.Name)
                    end
                    followingSlayer = nil
                end
            end
            return
        end
        
        -- FASE 2: Sem vivo, tenta executar mortos
        -- Primeiro da fila
        local deadData, deadIndex = getNextDeadFromQueue()
        if deadData then
            doExecute(deadData.npc, deadData.position)
            table.remove(deadSlayers, deadIndex)
            return
        end
        
        -- Procura qualquer morto executável no mapa
        local deadNpc, deadPos = pickExecutableDeadSlayer()
        if deadNpc then
            doExecute(deadNpc, deadPos)
            return
        end
        
        -- Nada pra fazer
        setStatus("Procurando alvos...")
        followingSlayer = nil
    end)
end

local function stopAutofarm()
    if connection then
        connection:Disconnect()
        connection = nil
    end
    removeSmoothMovement()
    followingSlayer = nil
    deadSlayers = {}
    setStatus("Parado")
end

-- ================== TOGGLE ==================
ToggleBtn.MouseButton1Click:Connect(function()
    AutoFarmActive = not AutoFarmActive
    
    if AutoFarmActive then
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
        ToggleBtn.Text = "ON"
        startAutofarm()
    else
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        ToggleBtn.Text = "OFF"
        stopAutofarm()
    end
end)

LocalPlayer.CharacterAdded:Connect(function()
    if AutoFarmActive then
        task.wait(1)
        local char = LocalPlayer.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if hrp then
            setupSmoothMovement(hrp)
        end
    end
end)

print("AutoFarm v5 carregado!")
