local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local AutoFarmActive = false
local followingSlayer = nil
local connection = nil
local executing = false

-- ================== CONFIGURA√á√ïES EDIT√ÅVEIS ==================
local config = {
    -- Dist√¢ncia do NPC
    attackDistance = 2,  -- Quantos studs na frente do NPC
    attackHeight = 1,    -- Altura acima do ch√£o
    
    -- Execu√ß√£o
    executeHeight = 2,   -- Altura ao executar
    executeWaitTime = 0.3,  -- Tempo de espera antes de executar
    executeCooldown = 2,    -- Tempo ap√≥s executar
    
    -- Comportamento
    followRange = 100,   -- Dist√¢ncia m√°xima pra seguir NPC
}

-- ================== GUI PRINCIPAL ==================
local gui = Instance.new("ScreenGui")
gui.Name = "AutoFarmGui"
gui.ResetOnSpawn = false
gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 150, 0, 80)
frame.Position = UDim2.new(0, 10, 0.5, -40)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.Parent = gui
frame.Active = true
frame.Draggable = true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 25)
title.BackgroundTransparency = 1
title.Text = "AutoFarm"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 14
title.Font = Enum.Font.GothamBold
title.Parent = frame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0.8, 0, 0, 35)
toggleBtn.Position = UDim2.new(0.1, 0, 0, 35)
toggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
toggleBtn.Text = "OFF"
toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleBtn.TextSize = 16
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.Parent = frame
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0, 6)

-- ================== GUI EDITOR ==================
local editorFrame = Instance.new("Frame")
editorFrame.Name = "EditorFrame"
editorFrame.Size = UDim2.new(0, 280, 0, 400)
editorFrame.Position = UDim2.new(0, 170, 0.5, -200)
editorFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
editorFrame.BorderSizePixel = 0
editorFrame.Parent = gui
editorFrame.Active = true
editorFrame.Draggable = true
editorFrame.Visible = false
Instance.new("UICorner", editorFrame).CornerRadius = UDim.new(0, 8)

local editorTitle = Instance.new("TextLabel")
editorTitle.Size = UDim2.new(1, 0, 0, 35)
editorTitle.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
editorTitle.Text = "‚öôÔ∏è Config de Combate"
editorTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
editorTitle.TextSize = 14
editorTitle.Font = Enum.Font.GothamBold
editorTitle.Parent = editorFrame
Instance.new("UICorner", editorTitle).CornerRadius = UDim.new(0, 8)

local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, -20, 1, -90)
scrollFrame.Position = UDim2.new(0, 10, 0, 45)
scrollFrame.BackgroundTransparency = 1
scrollFrame.BorderSizePixel = 0
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = editorFrame

local listLayout = Instance.new("UIListLayout")
listLayout.Padding = UDim.new(0, 10)
listLayout.Parent = scrollFrame

-- ================== FUN√á√ïES DO EDITOR ==================
local function createSection(parent, text)
    local section = Instance.new("TextLabel")
    section.Size = UDim2.new(1, 0, 0, 25)
    section.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    section.Text = text
    section.TextColor3 = Color3.fromRGB(100, 200, 255)
    section.TextSize = 13
    section.Font = Enum.Font.GothamBold
    section.TextXAlignment = Enum.TextXAlignment.Left
    section.TextXAlignment = Enum.TextXAlignment.Center
    section.Parent = parent
    Instance.new("UICorner", section).CornerRadius = UDim.new(0, 4)
    return section
end

local function createSlider(parent, labelText, min, max, defaultValue, decimals)
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, 0, 0, 50)
    container.BackgroundTransparency = 1
    container.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.6, 0, 0, 20)
    label.BackgroundTransparency = 1
    label.Text = labelText
    label.TextColor3 = Color3.fromRGB(220, 220, 220)
    label.TextSize = 11
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = container
    
    local input = Instance.new("TextBox")
    input.Size = UDim2.new(0.35, 0, 0, 28)
    input.Position = UDim2.new(0.63, 0, 0, 0)
    input.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    input.PlaceholderText = "Valor"
    input.Text = tostring(defaultValue)
    input.TextColor3 = Color3.fromRGB(100, 255, 100)
    input.TextSize = 13
    input.Font = Enum.Font.GothamBold
    input.ClearTextOnFocus = false
    input.Parent = container
    Instance.new("UICorner", input).CornerRadius = UDim.new(0, 6)
    
    local sliderBg = Instance.new("Frame")
    sliderBg.Size = UDim2.new(1, 0, 0, 10)
    sliderBg.Position = UDim2.new(0, 0, 0, 33)
    sliderBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    sliderBg.BorderSizePixel = 0
    sliderBg.Parent = container
    Instance.new("UICorner", sliderBg).CornerRadius = UDim.new(0, 5)
    
    local sliderFill = Instance.new("Frame")
    sliderFill.Size = UDim2.new((defaultValue - min) / (max - min), 0, 1, 0)
    sliderFill.BackgroundColor3 = Color3.fromRGB(100, 150, 255)
    sliderFill.BorderSizePixel = 0
    sliderFill.Parent = sliderBg
    Instance.new("UICorner", sliderFill).CornerRadius = UDim.new(0, 5)
    
    local sliderBtn = Instance.new("TextButton")
    sliderBtn.Size = UDim2.new(0, 20, 0, 20)
    sliderBtn.Position = UDim2.new((defaultValue - min) / (max - min), -10, 0.5, -10)
    sliderBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    sliderBtn.Text = ""
    sliderBtn.Parent = sliderBg
    Instance.new("UICorner", sliderBtn).CornerRadius = UDim.new(1, 0)
    
    local function updateValue(value, fromSlider)
        -- Se vier do slider, limita; se vier do input, permite qualquer valor
        if fromSlider then
            value = math.clamp(value, min, max)
        end
        
        if decimals == 0 then
            value = math.floor(value)
        else
            value = math.floor(value * (10^decimals)) / (10^decimals)
        end
        
        local percent = math.clamp((value - min) / (max - min), 0, 1)
        sliderFill.Size = UDim2.new(percent, 0, 1, 0)
        sliderBtn.Position = UDim2.new(percent, -10, 0.5, -10)
        input.Text = tostring(value)
        return value
    end
    
    local dragging = false
    sliderBtn.MouseButton1Down:Connect(function()
        dragging = true
    end)
    
    game:GetService("UserInputService").InputEnded:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    game:GetService("RunService").RenderStepped:Connect(function()
        if dragging then
            local mouse = LocalPlayer:GetMouse()
            local relativeX = mouse.X - sliderBg.AbsolutePosition.X
            local percent = math.clamp(relativeX / sliderBg.AbsoluteSize.X, 0, 1)
            local value = min + (max - min) * percent
            updateValue(value, true) -- true = vem do slider, limita
        end
    end)
    
    input.FocusLost:Connect(function()
        local value = tonumber(input.Text)
        if value then
            updateValue(value, false) -- false = vem do input, n√£o limita
        else
            input.Text = tostring(defaultValue)
        end
    end)
    
    return {
        getValue = function()
            return tonumber(input.Text) or defaultValue
        end,
        setValue = function(value)
            updateValue(value, false)
        end
    }
end

-- Criar sliders
createSection(scrollFrame, "üìè POSI√á√ÉO DE ATAQUE")
local attackDistSlider = createSlider(scrollFrame, "Dist√¢ncia na frente do NPC", 0, 10, config.attackDistance, 1)
local attackHeightSlider = createSlider(scrollFrame, "Altura do ch√£o", 0, 5, config.attackHeight, 1)

createSection(scrollFrame, "‚öîÔ∏è EXECU√á√ÉO")
local execHeightSlider = createSlider(scrollFrame, "Altura ao executar", 0, 5, config.executeHeight, 1)
local execWaitSlider = createSlider(scrollFrame, "Tempo antes de executar (s)", 0, 2, config.executeWaitTime, 1)
local execCooldownSlider = createSlider(scrollFrame, "Cooldown ap√≥s executar (s)", 0.5, 5, config.executeCooldown, 1)

createSection(scrollFrame, "üéØ COMPORTAMENTO")
local followRangeSlider = createSlider(scrollFrame, "Dist√¢ncia m√°x. pra seguir", 50, 500, config.followRange, 0)

scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 10)
listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 10)
end)

-- Bot√µes do editor
local btnContainer = Instance.new("Frame")
btnContainer.Size = UDim2.new(1, -20, 0, 35)
btnContainer.Position = UDim2.new(0, 10, 1, -45)
btnContainer.BackgroundTransparency = 1
btnContainer.Parent = editorFrame

local applyBtn = Instance.new("TextButton")
applyBtn.Size = UDim2.new(0.48, 0, 1, 0)
applyBtn.Position = UDim2.new(0, 0, 0, 0)
applyBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 250)
applyBtn.Text = "‚úì Aplicar"
applyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
applyBtn.TextSize = 13
applyBtn.Font = Enum.Font.GothamBold
applyBtn.Parent = btnContainer
Instance.new("UICorner", applyBtn).CornerRadius = UDim.new(0, 6)

local copyBtn = Instance.new("TextButton")
copyBtn.Size = UDim2.new(0.48, 0, 1, 0)
copyBtn.Position = UDim2.new(0.52, 0, 0, 0)
copyBtn.BackgroundColor3 = Color3.fromRGB(100, 50, 200)
copyBtn.Text = "üìã Copiar Config"
copyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
copyBtn.TextSize = 13
copyBtn.Font = Enum.Font.GothamBold
copyBtn.Parent = btnContainer
Instance.new("UICorner", copyBtn).CornerRadius = UDim.new(0, 6)

-- Bot√£o de abrir editor
local editBtn = Instance.new("TextButton")
editBtn.Size = UDim2.new(0, 20, 0, 20)
editBtn.Position = UDim2.new(1, -25, 0, 3)
editBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
editBtn.Text = "‚öôÔ∏è"
editBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
editBtn.TextSize = 12
editBtn.Parent = frame
Instance.new("UICorner", editBtn).CornerRadius = UDim.new(0, 4)

editBtn.MouseButton1Click:Connect(function()
    editorFrame.Visible = not editorFrame.Visible
end)

-- Aplicar mudan√ßas
applyBtn.MouseButton1Click:Connect(function()
    config.attackDistance = attackDistSlider.getValue()
    config.attackHeight = attackHeightSlider.getValue()
    config.executeHeight = execHeightSlider.getValue()
    config.executeWaitTime = execWaitSlider.getValue()
    config.executeCooldown = execCooldownSlider.getValue()
    config.followRange = followRangeSlider.getValue()
    
    applyBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
    applyBtn.Text = "‚úì Aplicado!"
    print("Config atualizada em tempo real!")
    task.wait(1)
    applyBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 250)
    applyBtn.Text = "‚úì Aplicar"
end)

-- Copiar configura√ß√µes
copyBtn.MouseButton1Click:Connect(function()
    local configStr = string.format([[
attackDistance = %d,  -- Dist√¢ncia na frente do NPC
attackHeight = %d,    -- Altura do ch√£o
executeHeight = %d,   -- Altura ao executar
executeWaitTime = %.1f,  -- Tempo antes de executar
executeCooldown = %.1f,  -- Cooldown ap√≥s executar
followRange = %d,     -- Dist√¢ncia m√°xima pra seguir]],
        config.attackDistance,
        config.attackHeight,
        config.executeHeight,
        config.executeWaitTime,
        config.executeCooldown,
        config.followRange
    )
    
    setclipboard(configStr)
    copyBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
    copyBtn.Text = "‚úì Copiado!"
    print("\n========== CONFIG COPIADA ==========")
    print(configStr)
    print("====================================\n")
    task.wait(1.5)
    copyBtn.BackgroundColor3 = Color3.fromRGB(100, 50, 200)
    copyBtn.Text = "üìã Copiar Config"
end)

-- ================== FUN√á√ïES DO AUTOFARM ==================
local function getRoot(model)
    return model:FindFirstChild("HumanoidRootPart") 
        or model:FindFirstChild("Torso") 
        or model:FindFirstChild("UpperTorso")
end

local function getHealth(model)
    return model:FindFirstChild("Health")
end

local function pickClosestSlayer()
    local char = LocalPlayer.Character
    if not char then return nil end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    
    local closest = nil
    local closestDist = math.huge
    
    for _, npc in ipairs(workspace:GetChildren()) do
        if npc.Name == "GenericSlayer" and npc:IsA("Model") then
            local root = getRoot(npc)
            local health = getHealth(npc)
            if root and health and health.Value > 0 then
                local dist = (root.Position - hrp.Position).Magnitude
                if dist < closestDist and dist <= config.followRange then
                    closestDist = dist
                    closest = npc
                end
            end
        end
    end
    return closest
end

local function executeSlayer()
    if not followingSlayer then return end
    local args = {"Character", "Execute"}
    local remote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Sync")
    remote:InvokeServer(unpack(args))
    print("Executed:", followingSlayer.Name)
end

local function attackSlayer(npc)
    if executing then return end
    local attackRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Async")
    if npc:FindFirstChild("Block") then
        attackRemote:FireServer("Katana", "Heavy")
    else
        attackRemote:FireServer("Katana", "Server")
    end
end

local function getTargetCFrame(root)
    return CFrame.new(
        root.Position - root.CFrame.LookVector * config.attackDistance + Vector3.new(0, config.attackHeight, 0), 
        root.Position
    )
end

local function startAutofarm()
    connection = RunService.Heartbeat:Connect(function()
        if not AutoFarmActive then return end
        local char = LocalPlayer.Character
        if not char or not char:FindFirstChild("HumanoidRootPart") then return end
        local hrp = char.HumanoidRootPart

        if not followingSlayer or not followingSlayer.Parent then
            followingSlayer = pickClosestSlayer()
            if followingSlayer then
                print("Seguindo: " .. followingSlayer.Name)
            else
                return
            end
        end

        local root = getRoot(followingSlayer)
        local health = getHealth(followingSlayer)
        if not root or not health then 
            followingSlayer = nil
            return 
        end

        local targetCF = getTargetCFrame(root)
        hrp.CFrame = targetCF

        if health.Value > 0 then
            attackSlayer(followingSlayer)
        else
            if not executing then
                executing = true
                hrp.CFrame = CFrame.new(root.Position + Vector3.new(0, config.executeHeight, 0), root.Position)
                task.wait(config.executeWaitTime)
                executeSlayer()
                task.delay(config.executeCooldown, function()
                    executing = false
                    followingSlayer = nil
                end)
            end
        end
    end)
end

local function stopAutofarm()
    if connection then
        connection:Disconnect()
        connection = nil
    end
    followingSlayer = nil
    executing = false
end

-- ================== TOGGLE AUTOFARM ==================
toggleBtn.MouseButton1Click:Connect(function()
    AutoFarmActive = not AutoFarmActive
    
    if AutoFarmActive then
        toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
        toggleBtn.Text = "ON"
        startAutofarm()
    else
        toggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        toggleBtn.Text = "OFF"
        stopAutofarm()
    end
end)

print("AutoFarm com Config Editor carregado!")
print("Clique no ‚öôÔ∏è pra ajustar as configs de combate!")
