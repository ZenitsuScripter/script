local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local AutoFarmActive = false
local followingSlayer = nil
local connection = nil
local executing = false

-- Objetos de movimento suave
local alignPos = nil
local alignOri = nil
local attachment = nil

-- CONFIGURAÇÕES
local HEIGHT_OFFSET = 7
local FORWARD_OFFSET = 0.5
local LOOK_DOWN_ANGLE = -80
local MOVE_SPEED = 50          -- velocidade do movimento (maior = mais rápido)
local RESPONSIVENESS = 25      -- responsividade da rotação

-- ================== GUI ==================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoFarmGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 150, 0, 80)
Frame.Position = UDim2.new(0, 10, 0.5, -40)
Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = Frame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 25)
Title.BackgroundTransparency = 1
Title.Text = "AutoFarm v3"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 14
Title.Font = Enum.Font.GothamBold
Title.Parent = Frame

local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Size = UDim2.new(0.8, 0, 0, 35)
ToggleBtn.Position = UDim2.new(0.1, 0, 0, 35)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
ToggleBtn.Text = "OFF"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 16
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.Parent = Frame

local BtnCorner = Instance.new("UICorner")
BtnCorner.CornerRadius = UDim.new(0, 6)
BtnCorner.Parent = ToggleBtn

-- ================== FUNÇÕES ==================
local function getRoot(model)
    return model:FindFirstChild("HumanoidRootPart") 
        or model:FindFirstChild("Torso") 
        or model:FindFirstChild("UpperTorso")
end

local function getHealth(model)
    return model:FindFirstChild("Health")
end

local function pickClosestSlayer()
    local char = LocalPlayer.Character
    if not char then return nil end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    
    local closest = nil
    local closestDist = math.huge
    
    for _, npc in ipairs(workspace:GetChildren()) do
        if npc.Name == "GenericSlayer" and npc:IsA("Model") then
            local root = getRoot(npc)
            local health = getHealth(npc)
            if root and health and health.Value > 0 then
                local dist = (root.Position - hrp.Position).Magnitude
                if dist < closestDist then
                    closestDist = dist
                    closest = npc
                end
            end
        end
    end
    return closest
end

local function executeSlayer()
    if not followingSlayer then return end
    local remote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Sync")
    remote:InvokeServer("Character", "Execute")
    print("Executed:", followingSlayer.Name)
end

local function attackSlayer(npc)
    if executing then return end
    local attackRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Async")
    if npc:FindFirstChild("Block") then
        attackRemote:FireServer("Katana", "Heavy")
    else
        attackRemote:FireServer("Katana", "Server")
    end
end

-- Cria os objetos de movimento suave
local function setupSmoothMovement(hrp)
    -- Remove antigos se existirem
    if attachment then attachment:Destroy() end
    if alignPos then alignPos:Destroy() end
    if alignOri then alignOri:Destroy() end
    
    -- Attachment no HRP
    attachment = Instance.new("Attachment")
    attachment.Name = "AutoFarmAttachment"
    attachment.Parent = hrp
    
    -- AlignPosition - controla posição suave
    alignPos = Instance.new("AlignPosition")
    alignPos.Name = "AutoFarmAlignPos"
    alignPos.Mode = Enum.PositionAlignmentMode.OneAttachment
    alignPos.Attachment0 = attachment
    alignPos.MaxForce = 100000
    alignPos.MaxVelocity = MOVE_SPEED
    alignPos.Responsiveness = RESPONSIVENESS
    alignPos.Parent = hrp
    
    -- AlignOrientation - controla rotação suave
    alignOri = Instance.new("AlignOrientation")
    alignOri.Name = "AutoFarmAlignOri"
    alignOri.Mode = Enum.OrientationAlignmentMode.OneAttachment
    alignOri.Attachment0 = attachment
    alignOri.MaxTorque = 100000
    alignOri.Responsiveness = RESPONSIVENESS
    alignOri.Parent = hrp
end

-- Remove os objetos de movimento
local function removeSmoothMovement()
    if attachment then attachment:Destroy() attachment = nil end
    if alignPos then alignPos:Destroy() alignPos = nil end
    if alignOri then alignOri:Destroy() alignOri = nil end
end

-- Calcula a posição/rotação ideal
local function getTargetCFrame(npcRoot)
    local npcPos = npcRoot.Position
    local npcLook = npcRoot.CFrame.LookVector
    
    local targetPos = npcPos + Vector3.new(0, HEIGHT_OFFSET, 0) + (npcLook * FORWARD_OFFSET)
    local baseCFrame = CFrame.new(targetPos, targetPos + npcLook)
    local finalCFrame = baseCFrame * CFrame.Angles(math.rad(LOOK_DOWN_ANGLE), 0, 0)
    
    return finalCFrame
end

local function startAutofarm()
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    setupSmoothMovement(hrp)
    
    connection = RunService.Heartbeat:Connect(function()
        if not AutoFarmActive then return end
        
        local char = LocalPlayer.Character
        if not char then return end
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        
        -- Recria se morreu/respawnou
        if not alignPos or not alignPos.Parent then
            setupSmoothMovement(hrp)
        end

        -- Pega novo alvo
        if not followingSlayer or not followingSlayer.Parent then
            followingSlayer = pickClosestSlayer()
            if followingSlayer then
                print("Seguindo:", followingSlayer.Name)
            end
            return
        end

        local root = getRoot(followingSlayer)
        local health = getHealth(followingSlayer)
        
        if not root or not health then
            followingSlayer = nil
            return
        end

        -- Atualiza posição/rotação alvo
        local targetCF = getTargetCFrame(root)
        alignPos.Position = targetCF.Position
        alignOri.CFrame = targetCF

        if health.Value > 0 then
            attackSlayer(followingSlayer)
        else
            if not executing then
                executing = true
                executeSlayer()
                task.delay(2, function()
                    executing = false
                    followingSlayer = nil
                end)
            end
        end
    end)
end

local function stopAutofarm()
    if connection then
        connection:Disconnect()
        connection = nil
    end
    removeSmoothMovement()
    followingSlayer = nil
    executing = false
end

-- ================== TOGGLE ==================
ToggleBtn.MouseButton1Click:Connect(function()
    AutoFarmActive = not AutoFarmActive
    
    if AutoFarmActive then
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
        ToggleBtn.Text = "ON"
        startAutofarm()
    else
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        ToggleBtn.Text = "OFF"
        stopAutofarm()
    end
end)

-- Limpa quando o personagem morre
LocalPlayer.CharacterAdded:Connect(function()
    if AutoFarmActive then
        task.wait(1)
        local char = LocalPlayer.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if hrp then
            setupSmoothMovement(hrp)
        end
    end
end)

print("AutoFarm v3 (Smooth) carregado! Clique no botão para ativar.")
