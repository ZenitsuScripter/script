local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local AutoFarmActive = false
local followingSlayer = nil
local connection = nil
local executing = false
local noclipEnabled = false
local noclipConnection = nil

-- CONFIGURAÇÕES
local TP_DISTANCE = 50        -- Se tiver mais longe que isso, dá TP
local ATTACK_DISTANCE = 10    -- Só ataca se tiver nessa distância

-- ================== GUI ==================
local gui = Instance.new("ScreenGui")
gui.Name = "AutoFarmGui"
gui.ResetOnSpawn = false
gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 150, 0, 80)
frame.Position = UDim2.new(0, 10, 0.5, -40)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.Parent = gui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 25)
title.BackgroundTransparency = 1
title.Text = "AutoFarm"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 14
title.Font = Enum.Font.GothamBold
title.Parent = frame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0.8, 0, 0, 35)
toggleBtn.Position = UDim2.new(0.1, 0, 0, 35)
toggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
toggleBtn.Text = "OFF"
toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleBtn.TextSize = 16
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.Parent = frame
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0, 6)

-- ================== FUNÇÕES ORIGINAIS ==================
local function getRoot(model)
    return model:FindFirstChild("HumanoidRootPart") 
        or model:FindFirstChild("Torso") 
        or model:FindFirstChild("UpperTorso")
end

local function getHealth(model)
    return model:FindFirstChild("Health")
end

local function pickRandomSlayer()
    local slayers = {}
    for _, npc in ipairs(workspace:GetChildren()) do
        if npc.Name == "GenericSlayer" and npc:IsA("Model") then
            local root = getRoot(npc)
            local health = getHealth(npc)
            if root and health and health.Value > 0 then
                table.insert(slayers, npc)
            end
        end
    end
    if #slayers == 0 then return nil end
    return slayers[math.random(1, #slayers)]
end

-- MELHORIA: Pega o mais próximo em vez de aleatório
local function pickClosestSlayer()
    local char = LocalPlayer.Character
    if not char then return nil end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    
    local closest = nil
    local closestDist = math.huge
    
    for _, npc in ipairs(workspace:GetChildren()) do
        if npc.Name == "GenericSlayer" and npc:IsA("Model") then
            local root = getRoot(npc)
            local health = getHealth(npc)
            if root and health and health.Value > 0 then
                local dist = (root.Position - hrp.Position).Magnitude
                if dist < closestDist then
                    closestDist = dist
                    closest = npc
                end
            end
        end
    end
    return closest, closestDist
end

local function executeSlayer()
    if not followingSlayer then return end
    local args = {"Character", "Execute"}
    local remote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Sync")
    remote:InvokeServer(unpack(args))
    print("Executed:", followingSlayer.Name)
end

local function attackSlayer(npc)
    if executing then return end
    local attackRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Async")
    if npc:FindFirstChild("Block") then
        attackRemote:FireServer("Katana", "Heavy")
    else
        attackRemote:FireServer("Katana", "Server")
    end
end

-- NOCLIP
local function enableNoclip()
    if noclipEnabled then return end
    noclipEnabled = true
    
    noclipConnection = RunService.Stepped:Connect(function()
        if not noclipEnabled then return end
        local char = LocalPlayer.Character
        if not char then return end
        
        for _, part in ipairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
    end)
    print("Noclip ON")
end

local function disableNoclip()
    if not noclipEnabled then return end
    noclipEnabled = false
    
    if noclipConnection then
        noclipConnection:Disconnect()
        noclipConnection = nil
    end
    
    -- Restaura colisão
    local char = LocalPlayer.Character
    if char then
        for _, part in ipairs(char:GetDescendants()) do
            if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                part.CanCollide = true
            end
        end
    end
    print("Noclip OFF")
end

-- MELHORIA: Posição com Lerp pra não tremer
local lastCFrame = nil

local function getTargetCFrame(root)
    return CFrame.new(root.Position - root.CFrame.LookVector * 2 + Vector3.new(0, 1, 0), root.Position)
end

local function startAutofarm()
    lastCFrame = nil
    
    connection = RunService.RenderStepped:Connect(function(dt)
        if not AutoFarmActive then return end
        local char = LocalPlayer.Character
        if not char or not char:FindFirstChild("HumanoidRootPart") then return end
        local hrp = char.HumanoidRootPart

        if not followingSlayer then
            followingSlayer, _ = pickClosestSlayer()
            if followingSlayer then
                print("Now following: " .. followingSlayer.Name)
            else
                return
            end
        end

        local root = getRoot(followingSlayer)
        local health = getHealth(followingSlayer)
        if not root or not health then 
            followingSlayer = nil
            return 
        end

        -- Calcula posição alvo
        local targetCF = getTargetCFrame(root)
        local dist = (hrp.Position - root.Position).Magnitude

        -- MELHORIA: TP se muito longe, senão anda com noclip
        if dist > TP_DISTANCE then
            enableNoclip()
            -- Move em direção ao alvo
            local direction = (targetCF.Position - hrp.Position).Unit
            hrp.CFrame = hrp.CFrame + direction * 2 -- Move 2 studs por frame
            return
        else
            -- Chegou perto, desativa noclip
            disableNoclip()
        end

        -- MELHORIA: Lerp pra suavizar (não treme)
        if lastCFrame then
            local lerpSpeed = math.clamp(dt * 15, 0.1, 0.5)
            hrp.CFrame = lastCFrame:Lerp(targetCF, lerpSpeed)
            lastCFrame = hrp.CFrame
        else
            hrp.CFrame = targetCF
            lastCFrame = targetCF
        end

        if health.Value > 0 then
            -- MELHORIA: Só ataca se tiver perto
            if dist <= ATTACK_DISTANCE then
                attackSlayer(followingSlayer)
            end
        else
            if not executing then
                executing = true
                -- MELHORIA: Para de mover e executa
                hrp.CFrame = CFrame.new(root.Position + Vector3.new(0, 2, 0), root.Position)
                task.wait(0.3)
                executeSlayer()
                task.delay(2, function()
                    executing = false
                    followingSlayer = nil
                    lastCFrame = nil
                end)
            end
        end
    end)
end

local function stopAutofarm()
    if connection then
        connection:Disconnect()
        connection = nil
    end
    disableNoclip()
    followingSlayer = nil
    executing = false
    lastCFrame = nil
end

-- ================== TOGGLE ==================
toggleBtn.MouseButton1Click:Connect(function()
    AutoFarmActive = not AutoFarmActive
    
    if AutoFarmActive then
        toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
        toggleBtn.Text = "ON"
        startAutofarm()
    else
        toggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        toggleBtn.Text = "OFF"
        stopAutofarm()
    end
end)

print("AutoFarm carregado! Clique no botão para ativar.")
